{"version":3,"file":"azureFnHook.js","sourceRoot":"","sources":["../../../src/traces/azureFnHook.ts"],"names":[],"mappings":"AAAA,uCAAuC;AACvC,kCAAkC;AAGlC,OAAO,EACL,OAAO,EACP,WAAW,EACX,YAAY,GAEb,MAAM,oBAAoB,CAAC;AAC5B,OAAO,EAAE,MAAM,EAAE,MAAM,mBAAmB,CAAC;AAE3C,MAAM,OAAO,kBAAkB;IAI7B;QACE,IAAI,CAAC;YACH,gDAAgD;YAChD,IAAI,CAAC,oBAAoB,GAAG,OAAO,CAAC,uBAAuB,CAAC,CAAC;YAC7D,IAAI,CAAC,qBAAqB,EAAE,CAAC;QAC/B,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,MAAM,CAAC,WAAW,EAAE,CAAC,KAAK,CACxB,sEAAsE,CACvE,CAAC;QACJ,CAAC;IACH,CAAC;IAEM,QAAQ;QACb,IAAI,IAAI,CAAC,kBAAkB,EAAE,CAAC;YAC5B,IAAI,CAAC,kBAAkB,CAAC,OAAO,EAAE,CAAC;YAClC,IAAI,CAAC,kBAAkB,GAAG,SAAS,CAAC;QACtC,CAAC;QACD,IAAI,CAAC,oBAAoB,GAAG,SAAS,CAAC;IACxC,CAAC;IAEO,qBAAqB;QAC3B,IAAI,CAAC,IAAI,CAAC,kBAAkB,EAAE,CAAC;YAC7B,IAAI,CAAC,kBAAkB,GAAG,IAAI,CAAC,oBAAoB,CAAC,YAAY,CAC9D,eAAe,EACf,KAAK,EAAE,oBAAyB,EAAE,EAAE;gBAClC,MAAM,GAAG,GAAmC,oBAAoB,CAAC,iBAAiB,CAAC;gBACnF,4CAA4C;gBAC5C,IAAI,gBAAgB,GAA+B,IAAI,CAAC;gBACxD,IAAI,CAAC;oBACH,IAAI,GAAG,CAAC,YAAY,EAAE,CAAC;wBACrB,gBAAgB,GAAG,WAAW,CAAC,OAAO,CAAC,YAAY,EAAE,GAAG,CAAC,YAAY,CAAC,CAAC;oBACzE,CAAC;oBACD,MAAM,cAAc,GAAG,gBAAgB,IAAI,OAAO,CAAC,MAAM,EAAE,CAAC;oBAC5D,oBAAoB,CAAC,gBAAgB,GAAG,OAAO,CAAC,IAAI,CAClD,cAAc,EACd,oBAAoB,CAAC,gBAAgB,CACtC,CAAC;gBACJ,CAAC;gBAAC,OAAO,GAAG,EAAE,CAAC;oBACb,MAAM,CAAC,WAAW,EAAE,CAAC,KAAK,CAAC,gDAAgD,EAAE,GAAG,CAAC,CAAC;gBACpF,CAAC;YACH,CAAC,CACF,CAAC;QACJ,CAAC;IACH,CAAC;CACF","sourcesContent":["// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT license.\n\nimport { Context as AzureFnContext } from \"@azure/functions\";\nimport {\n  context,\n  propagation,\n  ROOT_CONTEXT,\n  Context as OpenTelemetryContext,\n} from \"@opentelemetry/api\";\nimport { Logger } from \"../shared/logging\";\n\nexport class AzureFunctionsHook {\n  private _functionsCoreModule: any;\n  private _preInvocationHook: any;\n\n  constructor() {\n    try {\n      // TODO: Add types files when publicly available\n      this._functionsCoreModule = require(\"@azure/functions-core\");\n      this._addPreInvocationHook();\n    } catch (error) {\n      Logger.getInstance().debug(\n        \"@azure/functions-core failed to load, not running in Azure Functions\",\n      );\n    }\n  }\n\n  public shutdown() {\n    if (this._preInvocationHook) {\n      this._preInvocationHook.dispose();\n      this._preInvocationHook = undefined;\n    }\n    this._functionsCoreModule = undefined;\n  }\n\n  private _addPreInvocationHook() {\n    if (!this._preInvocationHook) {\n      this._preInvocationHook = this._functionsCoreModule.registerHook(\n        \"preInvocation\",\n        async (preInvocationContext: any) => {\n          const ctx: AzureFnContext = <AzureFnContext>preInvocationContext.invocationContext;\n          // Update context to use Azure Functions one\n          let extractedContext: OpenTelemetryContext | any = null;\n          try {\n            if (ctx.traceContext) {\n              extractedContext = propagation.extract(ROOT_CONTEXT, ctx.traceContext);\n            }\n            const currentContext = extractedContext || context.active();\n            preInvocationContext.functionCallback = context.bind(\n              currentContext,\n              preInvocationContext.functionCallback,\n            );\n          } catch (err) {\n            Logger.getInstance().error(\"Failed to propagate context in Azure Functions\", err);\n          }\n        },\n      );\n    }\n  }\n}\n"]}